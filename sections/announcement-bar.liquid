{% liquid
  assign announcement_text = section.settings.announcement_text
  assign speed = section.settings.animation_speed
%}

{% if announcement_text != blank %}
  <div
    x-data="announcementBar({{ speed }})"
    x-ref="announcementBar"
    x-show="isVisible"
    x-transition:leave="transition-all duration-300 ease-linear"
    x-transition:leave-start="translate-y-0"
    x-transition:leave-end="-translate-y-full"
    class="announcement-bar fixed top-0 left-4 right-4 w-auto overflow-hidden z-[52] h-[40px] transition-colors ease-linear duration-200"
    :class="{
      'delay-[600ms]': !$root.querySelector('html.is-changing')
    }"
    :style="`color: var(--header-theme, #643600)`"
  >

    <div
      class="relative z-10"
      x-ref="container"
      :style="`--scroll-speed: ${speed}s`"
    >
      <div
        class="announcement-content flex gap-1 md:justify-between h-[40px] items-center border-b border-current"
        x-ref="content"
        :class="{ 'is-scrolling': isScrolling }"
      >
        <div class="announcement-track-container flex-1 overflow-hidden">
          <div class="announcement-track flex" x-ref="track">
            <span class="announcement-text whitespace-nowrap small-accent">
              {{ announcement_text }}
            </span>
            <span
              class="announcement-text whitespace-nowrap px-4 small-accent"
              x-show="isScrolling"
              aria-hidden="true"
            >
              {{ announcement_text }}
            </span>
            <span
              class="announcement-text whitespace-nowrap px-4 small-accent"
              x-show="isScrolling"
              aria-hidden="true"
            >
              {{ announcement_text }}
            </span>
          </div>
          <!-- Left fade overlay -->
          <div
            class="announcement-fade announcement-fade--left"
            x-show="isScrolling && hasStartedScrolling"
            x-transition:enter="transition-opacity duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
          ></div>
          <!-- Right fade overlay -->
          <div
            class="announcement-fade announcement-fade--right"
            x-show="isScrolling"
          ></div>
        </div>

        <!-- Close button -->
      <button
        @click="close"
        type="button"
        class="h-[40px] flex items-center justify-center small-accent hover:opacity-50 transition-opacity duration-300 ease-linear z-30"
        aria-label="Close announcement"
      >
        (x)
      </button>
      </div>
    </div>
  </div>



  <style>
    .announcement-content {
      position: relative;
      width: 100%;
    }

    .announcement-content.is-scrolling {
      cursor: pointer;
    }

    .announcement-text a {
      text-decoration: underline;
    }

    .announcement-track-container {
      position: relative;
      overflow: hidden;
    }

    .announcement-track {
      display: inline-flex;
      will-change: transform;
    }

    .announcement-content.is-scrolling .announcement-track {
      animation: marquee var(--scroll-speed, 20s) linear infinite;
    }

    @media (prefers-reduced-motion: reduce) {
      .announcement-content.is-scrolling .announcement-track {
        animation: none;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    .announcement-content.is-scrolling.paused .announcement-track {
      animation-play-state: paused;
    }

    @keyframes marquee {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-33.333%);
      }
    }

    .announcement-fade {
      position: absolute;
      top: 0;
      height: 90%;
      width: 15px;
      pointer-events: none;
      z-index: 20;
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
    }

    .announcement-fade--left {
      left: -6px;
    }

    .announcement-fade--right {
      right: -6px;
    }

    /* Additional support for image backgrounds */
    .announcement-bar::before {
      content: '';
      position: absolute;
      inset: 0;
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
      z-index: 5;
      pointer-events: none;
    }

    .announcement-content[href]:hover, .announcement-text a:hover {
      opacity: 0.9;
      transition: opacity 0.2s ease;
    }


  </style>
{% endif %}

{% schema %}
{
  "name": "Announcement Bar",
  "tag": "section",
  "class": "announcement-bar-section",
  "settings": [
    {
      "type": "richtext",
      "id": "announcement_text",
      "label": "Announcement text",
      "default": "<p>Free shipping on orders over $100 • New arrivals weekly • <a href=\"/collections/all\">Shop now</a></p>"
    },
    {
      "type": "range",
      "id": "animation_speed",
      "label": "Animation speed (seconds)",
      "min": 10,
      "max": 60,
      "step": 5,
      "default": 20,
      "info": "Lower is faster"
    }
  ],
  "presets": [
    {
      "name": "Announcement Bar"
    }
  ]
}
{% endschema %}
