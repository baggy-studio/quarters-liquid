{% assign is_all_collection = false %}

{% if collection.url == '/collections/all' %}
  {% assign is_all_collection = true %}
{% endif %}

{% assign primary_links = section.settings.menu.links | first %}
{% assign secondary_links = section.settings.menu.links | last %}

{% assign parent_link = primary_links.links | where: 'title', collection.title | first %}
{% assign parent_collection = parent_link.object %}

{% if parent_link == null %}
  {% for link in primary_links.links %}
    {% if link.links.size > 0 %}
      {% assign sub_link = link.links | where: 'title', collection.title | first %}
      {% if sub_link %}
        {% assign parent_link = link %}
        {% assign parent_collection = link.object %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

<nav aria-label="Collection Navigation" class="w-full grid grid-cols-2 lg:grid-cols-20 gap-2 lg:gap-3 subheading">
  {% unless is_all_collection %}
    <a
      href="/collections/all"
      title="All Items"
      class="hover:underline leading-none whitespace-nowrap col-span-2 lg:block hidden"
    >
      All Items
    </a>
    <h2 class="whitespace-nowrap leading-none col-span-2">
      {{ parent_collection.title }}
    </h2>
  {% else %}
    <h2 class="whitespace-nowrap leading-none col-span-2 lg:underline">
      <a
        href="/collections/all"
        title="All Items"
        class="contents"
      >
        All Items
      </a>
    </h2>
  {% endunless %}

  {% if is_all_collection %}
    {% if primary_links.links.size > 0 %}
      <ul class="col-span-13 flex items-center gap-4">
        {% for link in primary_links.links -%}
          {% assign collection = link.object %}
          <li class="contents">
            <a
              title="{{ collection.title }}"
              class="collection-link"
              href="{{ collection.url }}"
            >
              {{ collection.title }}
            </a>
          </li>
        {%- endfor -%}
      </ul>
    {% endif %}
    {% if secondary_links.links.size > 0 %}
      <ul class="col-span-5 flex items-center gap-4">
        {% for link in secondary_links.links -%}
          {% assign collection = link.object %}
          <li class="contents">
            <a
              title="{{ collection.title }}"
              class="collection-link whitespace-nowrap"
              href="{{ collection.url }}"
            >
              {{ collection.title }}
            </a>
          </li>
        {%- endfor -%}
      </ul>
    {% endif %}
  {% endif %}

  {% unless is_all_collection %}
    <ul
      class="lg:col-span-16 flex items-center flex-wrap gap-x-4 gap-y-2"
    >
      <script data-collection-filters type="application/json">
        {
          "collection_url": {{ parent_collection.url | json }},
          "filters": [
            {% for filter in parent_link.links -%}
              {% if filter.type == 'collection_link' %}
                {
                  "title": {{ filter.title | json }},
                  "url": {{ filter.url | json }}
                  {% unless forloop.last %},{% endunless %}
                }
              {% endif %}
            {%- endfor %}
          ]
        }
      </script>
      {% unless parent_link.links.size == 0 %}
        <li
          class="contents"
          x-data="{ active: false }"
          x-effect="active = activeUrl === '{{ parent_collection.url }}'"
        >
          <a
            title="All {{ parent_collection.title }}"
            class="collection-link"
            href="{{ parent_collection.url }}"
:aria-current="active ? 'page' : undefined"
            {% if collection.url == parent_collection.url %}
              aria-current="page"
            {% endif %}
          >
            All {{ parent_collection.title }}
          </a>
        </li>
      {% endunless %}
      {% for filter in parent_link.links -%}
        {% if filter.type == 'collection_link' %}
          <li
            class="contents"
            x-data="{ active: false }"
            x-effect="active = activeUrl === '{{ filter.url }}'"
          >
            {% assign collection_filter = filter.object %}
            <a
              title="{{ filter.title }}"
              class="collection-link"
              :aria-current="active ? 'page' : undefined"
              :href="active ? '{{ parent_collection.url }}' : '{{ filter.url }}'"
              {% if collection.url == collection_filter.url %}
                aria-current="page"
                href="{{ parent_collection.url }}"
              {% else %}
                href="{{ filter.url }}"
              {% endif %}
            >
              {{ filter.title }}
            </a>
          </li>
        {% endif %}
      {%- endfor %}
    </ul>
  {% endunless %}
</nav>
