{% capture product_media_data %}
  {% assign variant_featured_media_ids = '' %}
{% assign filtered_product_media = '' %}
{% assign selected_variant_media = selected_variant.featured_media %}
{% assign variant_media_metafields = selected_variant.metafields.custom.media.value %}
{% assign total_media_count = 1 %}

{% if selected_variant_media %}
  {% assign total_media_count = total_media_count | plus: 1 %}
{% else %}
  {% assign selected_variant_media = product.featured_image %}
{% endif %}

{% for variant in product.variants %}
  {% if variant.featured_media %}
    {% assign variant_featured_media_ids = variant_featured_media_ids
      | append: variant.featured_media.id
      | append: ','
    %}
  {% endif %}
{% endfor %}

{% for media in product.media %}
  {% unless variant_featured_media_ids contains media.id %}
    {% assign filtered_product_media = filtered_product_media | append: media.id | append: ',' %}
  {% endunless %}
{% endfor %}

{% assign filtered_product_media_ids = filtered_product_media | split: ',' %}

{% if variant_media_metafields %}
  {% for media in variant_media_metafields %}
    {% assign total_media_count = total_media_count | plus: 1 %}
  {% endfor %}
{% endif %}

{% if section.settings.share_product_media %}
  {% assign total_media_count = total_media_count | plus: filtered_product_media_ids.size %}
  {% endif %}
{% endcapture %}
