{% assign variant_featured_media_ids = '' %}
{% assign filtered_product_media = '' %}

{% assign variant_media_metafields = selected_variant.metafields.custom.media.value %}

{% for variant in product.variants %}
  {% if variant.featured_media %}
    {% assign variant_featured_media_ids = variant_featured_media_ids
      | append: variant.featured_media.id
      | append: ','
    %}
  {% endif %}
{% endfor %}

{% for media in product.media %}
  {% unless variant_featured_media_ids contains media.id %}
    {% assign filtered_product_media = filtered_product_media | append: media.id | append: ',' %}
  {% endunless %}
{% endfor %}

{% assign selected_variant_media = selected_variant.featured_media %}

{% assign filtered_product_media_ids = filtered_product_media | split: ',' %}

<div id="product-variant-media-mobile" class="contents">
  {% if variant_media.size > 0 or filtered_product_media_ids.size > 0 %}
    <div
      x-data="
        carousel({
        align: 'start',
        loop: false
        })
      "
      class="w-[calc(100%+32px)] -ml-4 overflow-hidden"
    >
      <ul class="w-full grid auto-cols-[calc(40%-10px)] grid-flow-col gap-2 pl-4">
        {% if selected_variant_media %}
          <li class="w-full h-full flex flex-col gap-1 basis-full shrink-0 relative overflow-hidden mr-2">
            <div class="w-full aspect-[140/175] relative overflow-hidden">
              {% render 'image',
                image: selected_variant_media,
                width: 140,
                height: 175,
                sizes: '@media (min-width: 1024px) calc(40vw - 5px), calc(100vw - 24px)'
              %}
            </div>
            <p class="small-accent">01</p>
          </li>
        {% endif %}
        {% if variant_media_metafields %}
          {% for media in variant_media_metafields %}
            <li class="w-full h-full flex flex-col gap-1 basis-full shrink-0 relative overflow-hidden mr-2">
              <div class="w-full aspect-[140/175] relative overflow-hidden">
                {% render 'image',
                  image: media,
                  width: 140,
                  height: 175,
                  sizes: '@media (min-width: 1024px) calc(40vw - 5px), calc(100vw - 24px)'
                %}
              </div>
              <p class="small-accent">01</p>
            </li>
          {% endfor %}
        {% endif %}
        {% if section.settings.share_product_media %}
          {% for media_id in filtered_product_media_ids %}
            {% assign media_id_number = media_id | plus: 0 %}
            {% assign media = product.media | where: 'id', media_id_number | first %}
            <li class="w-full h-full flex flex-col gap-1 basis-full shrink-0 relative overflow-hidden mr-2 last:mr-4">
              <div class="w-full aspect-[140/175] relative overflow-hidden">
                {% render 'image',
                  image: media,
                  width: 140,
                  height: 175,
                  sizes: '@media (min-width: 1024px) calc(40vw - 5px), calc(100vw - 24px)'
                %}
              </div>
              <p class="small-accent">01</p>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>
  {% endif %}
</div>
